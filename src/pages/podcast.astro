---
import { parseStringPromise } from "xml2js";
import BaseLayout from "../layouts/BaseLayout.astro";
import { Image } from "@astrojs/image/components";

const RSS_FEED = "https://feeds.megaphone.fm/GLT8247080596";

const response = await fetch(RSS_FEED);
const text = await response.text();
const data = await parseStringPromise(text);

// Estrarre episodi in modo sicuro
const channel = data?.rss?.channel?.[0];
const items = channel?.item || [];

const episodes = items
  .slice(0, 5)
  .map((ep) => ({
    title: ep?.title?.[0] || "Titolo mancante",
    date: ep?.pubDate ? new Date(ep.pubDate[0]).toLocaleDateString("it-IT", {
      day: "numeric",
      month: "long",
      year: "numeric"
    }) : "",
    audioUrl: ep?.enclosure?.[0]?.$.url || "",
    description: ep?.description?.[0] || "",
    imageUrl: ep?.["itunes:image"]?.[0]?.$.href || "/default-podcast-image.png",
  }));


// Immagine generale del podcast con fallback
const podcastImage = channel?.image?.[0]?.url?.[0] || "/default-podcast-image.png";
---

<BaseLayout sideBarActiveItemID="home">

  <script>
    window.loadAudio = function loadAudio(button, audioUrl) {
      const container = button.parentElement;
      button.style.display = "none";
      const audio = document.createElement("audio");
      audio.controls = true;
      audio.preload = "metadata";
      audio.className = "mt-2 w-full";
      const source = document.createElement("source");
      source.src = audioUrl;
      source.type = "audio/mpeg";
      audio.appendChild(source);
      container.appendChild(audio);
    };
  </script>

  <h1 class="text-3xl font-bold text-center mb-6">ðŸŽ™ Podcast</h1>

  <!-- Immagine generale -->
  <div class="flex justify-center mb-6">
    <img src={podcastImage} alt="Podcast Image" class="rounded-lg shadow-lg w-1/3 max-w-xs" />
  </div>

  <div class="rounded-lg bg-base-100 p-4">
    {episodes.length > 0 ? (
      episodes.map((ep, index) => (
        <div class="hero-content flex-col md:flex-row mb-6" key={index}>
          <Image
            src={podcastImage}
            aspectRatio="16:9"
            width={750}
            format="webp"
            alt={`Immagine per ${ep.title}`}
            class="max-w-full md:max-w-[13rem] rounded-lg shadow-md mb-4 md:mb-0 md:mr-4"
          />
          <div class="grow w-full">
            <h2 class="text-xl font-bold">{ep.title}</h2>
            <p class="text-gray-500 text-sm">{ep.date}</p>
            <p class="py-1 text-1xl line-clamp-4" set:html={ep.description}></p>
            {ep.audioUrl && (
              <div id={`audio-container-${index}`} class="mt-4">
                <button 
                  class="btn btn-primary w-full"
                  onclick={`loadAudio(this, '${ep.audioUrl}')`}
                >
                  Play
                </button>
              </div>
            )}
          </div>
        </div>
      ))
    ) : (
      <p class="col-span-full text-center">Nessun episodio disponibile.</p>
    )}
  </div>
</BaseLayout>
